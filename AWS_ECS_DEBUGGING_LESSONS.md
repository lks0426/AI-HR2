# AWS ECS部署问题调试经验总结

## 🎯 核心问题：CSS间歇性404错误

### 症状表现
- 网站CSS文件随机返回404，导致样式时好时坏
- 测试结果：约40%请求返回404，60%返回200

### 真正根因
**多个同名服务连接到同一个负载均衡器，导致流量在新旧版本间轮询**

## 🚨 错误的诊断过程（应该避免）

### ❌ 错误方法1：反复修改Dockerfile
- **做法**：怀疑Docker构建问题，多次修改Dockerfile配置
- **问题**：本地测试正常，说明Docker构建没问题
- **浪费时间**：几小时的重复构建和测试

### ❌ 错误方法2：修改Next.js配置
- **做法**：修改`output: 'standalone'`等配置
- **问题**：原配置是工作的，修改反而引入新问题
- **违反原则**：破坏了已验证的工作配置

### ❌ 错误方法3：暴力删除重建
- **做法**：删除服务重新创建`ai-hr-service-v2`
- **结果**：暂时解决但没有根治，重复服务仍然存在
- **隐患**：没有清理旧资源，问题可能再现

## ✅ 正确的诊断方法

### 🔍 系统性排查步骤

1. **负载均衡器检查**
```bash
aws elbv2 describe-target-health --target-group-arn [ARN]
```
发现：同一目标组有多个目标在运行

2. **ECS服务清单**
```bash
aws ecs list-services --cluster [cluster-name]
```
发现：多个集群中有重复的服务名

3. **流量追踪**
```bash
# 连续测试CSS文件
for i in {1..10}; do curl -I [CSS-URL]; done
```
发现：40%返回404，60%返回200 → 确认负载均衡器轮询问题

### 🎯 根本原因定位

架构问题：
```
负载均衡器 → 目标组 → 多个服务版本
                    ├── 旧版本(CSS有问题)
                    └── 新版本(CSS正常)
```

## 🛠️ 正确解决方案

### 1. 识别活跃服务
- `ai-hr-cluster/ai-hr-service-v2` (39分钟前) ← 正确版本
- `lks0426-cluster/ai-hr-service` (19小时前) ← 重复服务
- `lks0426-cluster/lks0426-service` (14天前) ← 旧版本

### 2. 逐步清理
- **步骤1**: 停止旧服务（设置desired count = 0）
- **步骤2**: 验证CSS问题消失
- **步骤3**: 删除停止的服务
- **步骤4**: 清理无用集群

### 3. 最终架构
干净架构：一个负载均衡器 → 一个目标组 → 一个活跃服务

## 📚 关键经验教训

### 🎓 诊断原则
1. **症状 ≠ 根因**：CSS 404不一定是Docker问题
2. **系统性检查**：先看基础设施再看代码
3. **保护工作配置**：不要修改已验证的设置
4. **追踪流量路径**：从用户请求到后端容器的完整链路

### 🔧 AWS ECS最佳实践
- **一个功能一个服务**：避免同一功能的多版本并存
- **蓝绿部署**：新版本验证后再停止旧版本
- **资源清理**：部署后及时清理旧资源
- **监控目标组**：定期检查负载均衡器目标健康状态

### 🚨 避免的错误模式
- ❌ 遇到问题就修改配置
- ❌ 重复创建而不清理旧资源
- ❌ 单点测试而忽略系统整体
- ❌ 暴力解决而不追根溯源

## 💡 正确的问题诊断流程

### 🔍 五步诊断法
1. **确认症状**（什么情况下出现问题）
2. **检查基础设施**（负载均衡器、目标组、服务列表）
3. **追踪请求路径**（从DNS到容器的完整链路）
4. **定位根本原因**（通常是配置冲突而非代码问题）
5. **最小化修复**（只改必须改的部分）

### 🛡️ 安全原则
- 工作的配置神圣不可侵犯
- 先诊断再治疗，不要猜测性修改
- 每次变更后验证，确保问题真正解决
- 清理资源，避免重复部署累积问题

## 🎯 核心洞察

**这次问题的本质是AWS资源管理问题，而不是代码问题。正确的方法是清理重复资源，而不是修改工作的代码配置。**

## 📝 调试命令速查表

```bash
# 1. 列出所有集群
aws ecs list-clusters

# 2. 列出集群中的服务
aws ecs list-services --cluster [cluster-name]

# 3. 检查服务详情
aws ecs describe-services --cluster [cluster-name] --services [service-name]

# 4. 检查目标组健康状态
aws elbv2 describe-target-health --target-group-arn [target-group-arn]

# 5. 检查负载均衡器
aws elbv2 describe-load-balancers --names [load-balancer-name]

# 6. 停止服务（保留定义）
aws ecs update-service --cluster [cluster-name] --service [service-name] --desired-count 0

# 7. 删除服务
aws ecs delete-service --cluster [cluster-name] --service [service-name] --force

# 8. 连续测试诊断
for i in {1..20}; do curl -I [URL] | grep HTTP; sleep 1; done
```

## 🔑 关键启示

1. **间歇性问题通常指向负载均衡**：如果问题时好时坏，很可能是多个版本在轮询
2. **先看基础设施，后看代码**：大多数部署问题源于资源配置而非代码bug
3. **清理比修复更重要**：AWS资源容易累积，定期清理避免冲突
4. **系统思维优于局部优化**：要看整个请求链路，而不是只盯着一个组件

---

*记录时间：2025-07-22*
*问题解决用时：从反复修改代码到找到根因，浪费了数小时。如果一开始就检查基础设施，10分钟就能解决。*